<!--
Sync Impact Report:
===================
Version: TEMPLATE → 1.0.0
Change Type: INITIAL CONSTITUTION (MAJOR)

Principles Added:
- 规范先于代码 (Specification-First Development)
- 质量不可妥协 (Quality Non-Negotiable)
- 用户价值至上 (User Value First)
- 透明可追溯 (Transparency & Traceability)
- TDD 强制执行 (Test-Driven Development Mandatory)
- 安全优先 (Security First)
- 性能合约 (Performance Contract)

Sections Added:
- 核心价值观
- 不可违反的原则
- 开发流程规范
- 治理机制

Templates Updated:
- ✅ .specify/templates/plan-template.md - Constitution check section updated
- ✅ .specify/templates/spec-template.md - Requirements aligned with principles
- ✅ .specify/templates/tasks-template.md - Task categorization reflects TDD principle
- ⚠️ CLAUDE.md - Needs manual update to reference .specify/memory/constitution.md
- ⚠️ RALPH_LOOP_GUIDE.md - May need update to reference new constitution

Files to be Removed/Updated:
- 📁 docs/spec-kit/ - ENTIRE DIRECTORY TO BE REMOVED
  - CONSTITUTION.md → .specify/memory/constitution.md (this file)
  - SDD_GUIDE.md → Integrated into this constitution
  - STATUS.md → To be replaced by simpler tracking
  - CHANGELOG.md → Not needed in constitution
  - TASK_MASTER_INTEGRATION.md → To be integrated into CLAUDE.md
  - templates/ → .specify/templates/
  - examples/ → Can be archived or removed
  - specs/ → Move to root specs/ directory
  - scripts/ → Archive or remove

Follow-up TODOs:
- Remove docs/spec-kit/ directory completely
- Update CLAUDE.md to reference .specify/memory/constitution.md
- Migrate any active specs from docs/spec-kit/specs/ to root specs/
- Update all references from "docs/spec-kit/CONSTITUTION.md" to ".specify/memory/constitution.md"
-->

# 小芽家教项目宪章

## 序言

本宪章确立小芽家教项目开发的**核心价值观**、**基本原则**和**不可违反的规则**。所有规范文档、代码实现、开发流程都必须遵守本宪章。

本宪章是项目的最高法律，任何其他文档、流程或实践都不能与本宪章相冲突。

---

## 核心价值观

### I. 规范先于代码

**原则**：任何功能实现之前，必须先有规范文档。

**工作流程**：
```
需求分析 → 编写规范 → 规范审查 → 规范批准 → 开始实施 → 验证合规 → 标记完成
```

**不可违反的规则**：
- ❌ 禁止在没有规范的情况下编写代码
- ❌ 禁止"事后补文档"的做法
- ❌ 禁止规范和代码不一致
- ✅ 必须先编写规范，获得批准后再编码
- ✅ 代码变更时必须同步更新规范
- ✅ 规范审查未通过不启动开发

**理由**：规范先行确保所有参与者对"做什么"和"怎么做"达成共识，避免返工和歧义，提高代码质量和可维护性。

---

### II. 质量不可妥协

**原则**：质量标准是不可协商的底线。

**最低质量标准**：
- 单元测试覆盖率必须 ≥ 80%
- 所有测试用例必须通过
- 代码必须通过审查
- API 响应时间必须符合规范要求
- 安全漏洞零容忍

**违反后果**：
- 测试覆盖率不足 → 禁止合并代码
- 测试失败 → 禁止部署
- 安全漏洞 → 立即修复，优先级 P0

**理由**：质量是产品的生命线，特别是在教育领域，低质量的代码会直接影响用户体验和学习效果。

---

### III. 用户价值至上

**原则**：所有技术决策必须服务于用户价值。

**决策优先级**（从高到低）：
1. **用户体验**：一年级学生的认知能力和使用习惯
2. **教育效果**：学习效果提升和知识掌握
3. **家长信任**：数据安全、隐私保护和内容健康
4. **技术优雅**：代码质量和可维护性

**冲突解决原则**：
- 当技术优雅与用户体验冲突时 → 优先用户体验
- 当功能丰富与简洁易用冲突时 → 优先简洁易用
- 当性能与安全冲突时 → 优先安全

**理由**：技术是为用户服务的，不是为技术而技术。我们的目标是为一年级学生提供优质的教育体验，而不是展示技术能力。

---

### IV. 透明可追溯

**原则**：所有决策和变更必须有据可查。

**可追溯性要求**：
- 每个功能必须能追溯到业务需求（PRD）
- 每个 Bug 修复必须记录根因分析
- 每次技术决策必须记录决策理由（ADR）
- 每个 Git Commit 必须关联 Task ID 和 Spec ID

**证据链**：
```
PRD → 规范文档 (Spec) → Task ID → Commit → 代码
```

**理由**：可追溯性使得项目历史清晰、决策透明、问题定位快速，也便于知识传承和新人上手。

---

## 不可违反的原则

### P1: 规范完整性原则

**规则**：任何规范必须包含以下全部章节，缺一不可：

1. **元数据**：spec_id, title, status, phase, author, created, updated
2. **概述**：功能描述、业务价值、依赖关系
3. **用户场景**：用户故事、验收标准、边缘情况
4. **功能需求**：功能需求清单（FR-XXX）
5. **成功标准**：可衡量的成功标准（SC-XXX）
6. **技术规范**：API、数据模型、业务逻辑（如适用）
7. **测试规范**：测试策略和测试用例
8. **实施计划**：步骤、风险评估、完成标准

**例外程序**：无例外。

**验证方式**：使用 `speckit.analyze` 命令自动检查规范完整性。

---

### P2: TDD 强制执行原则

**规则**：所有功能开发必须遵循测试驱动开发（TDD）流程。

**TDD 循环**：
```
Red (红灯) → Green (绿灯) → Refactor (重构)
   ↓            ↓              ↓
Commit       Commit         Commit
  测试         功能           重构
```

**不可违反的规则**：
- ❌ 禁止先写功能代码，再补测试
- ❌ 禁止一次性提交测试+功能代码
- ❌ 禁止跳过 Red 阶段直接写 Green
- ✅ 必须先写失败的测试（Red）
- ✅ 必须运行测试确认失败后才开始编码
- ✅ 必须编写最少代码让测试通过（Green）
- ✅ 每个阶段独立提交代码

**提交格式**：
- Red 阶段：`[Task-ID] test: 添加 XXX 测试 (Red)`
- Green 阶段：`[Task-ID] feat: 实现 XXX 功能 (Green)`
- Refactor 阶段：`[Task-ID] refactor: 优化 XXX 代码 (Refactor)`

**理由**：TDD 确保代码质量，防止"写完代码不知道怎么测试"的情况，同时推动简单设计。

---

### P3: 安全优先原则

**规则**：安全是最高优先级，任何安全隐患必须立即修复。

**安全红线**（不可违反）：
1. **禁止硬编码敏感信息**：API Key、密码、Token 必须使用环境变量
2. **禁止 SQL 注入**：必须使用 ORM 或参数化查询
3. **禁止未授权访问**：所有 API 必须认证和授权
4. **禁止泄露敏感数据**：日志中不能包含密码、Token；响应中不能包含内部实现细节
5. **儿童数据保护**：学生数据必须加密存储；第三方共享必须家长同意

**违反后果**：
- 安全漏洞 → 立即修复，优先级 P0
- 禁止合并包含安全问题的代码
- 禁止部署包含安全问题的版本

**理由**：小芽家教面向儿童，数据安全和隐私保护是法律要求，也是家长信任的基础。

---

### P4: 性能合约原则

**规则**：性能规范是硬性指标，必须达到。

**性能要求**：
- API 响应时间（p95）必须 ≤ 规范值
- 并发支持必须 ≥ 规范值
- 数据库查询时间必须 ≤ 规范值
- 前端首屏加载时间必须 ≤ 规范值

**测试要求**：
- 每个 API 规范必须包含性能要求
- 性能测试必须在集成测试阶段执行
- 性能不达标 → 禁止合并

**优化义务**：
- 性能不达标必须优化
- 不能为了功能牺牲性能
- 不能降低性能标准

**理由**：性能直接影响用户体验，特别是对于儿童应用，快速响应是保持注意力的关键。

---

### P5: 向后兼容原则

**规则**：变更必须保持向后兼容，除非在规范中明确声明破坏性变更。

**兼容性要求**：
- API 端点路径不能变更
- 请求/响应格式不能破坏性变更
- 数据库表结构变更必须提供迁移
- 配置文件变更必须有升级指南

**破坏性变更流程**：
1. 在规范中明确标记 `BREAKING CHANGE`
2. 提供详细的迁移指南
3. 设置废弃期（至少 2 个版本）
4. 通知所有依赖方
5. 评估影响范围

**理由**：向后兼容保护现有用户和集成，减少迁移成本。

---

### P6: 代码规范一致性原则

**规则**：代码必须与规范保持 100% 一致。

**一致性检查**：
1. **API 一致性**：端点路径、请求/响应格式、错误码必须与规范一致
2. **数据模型一致性**：字段名、字段类型、约束条件必须与规范一致
3. **业务逻辑一致性**：验证规则、错误处理、边界条件必须与规范一致

**冲突处理**：
- 发现代码与规范不一致 → 立即停止合并
- 确定是规范错误还是代码错误
- 规范错误 → 更新规范，重新审查
- 代码错误 → 修改代码，重新测试

**理由**：规范是"合同"，代码必须遵守合同，否则规范失去意义。

---

## 开发流程规范

### 规范驱动开发（SDD）流程

```
1. 需求分析
   ├─ 阅读 PRD
   ├─ 理解业务需求
   └─ 明确用户价值

2. 编写规范
   ├─ 使用 /speckit.specify 创建规范
   ├─ 填写所有必需章节（P1）
   ├─ 明确功能需求和成功标准
   └─ 定义验收标准

3. 规范审查
   ├─ 使用 /speckit.analyze 检查完整性
   ├─ 团队审查规范内容
   ├─ 检查是否符合本宪章
   └─ 批准或要求修改

4. 创建实施计划
   ├─ 使用 /speckit.plan 创建计划
   ├─ 进行 Constitution Check
   ├─ 定义技术方案和数据模型
   └─ 生成任务清单

5. 生成任务清单
   ├─ 使用 /speckit.tasks 生成任务
   ├─ 任务按用户故事组织
   ├─ 确保独立可测试
   └─ 定义依赖关系

6. 执行实施（Ralph Loop）
   ├─ 启动 /ralph-loop
   ├─ 遵循 TDD 循环（P2）
   ├─ 每个任务独立提交
   └─ 保持与规范一致（P6）

7. 验证合规
   ├─ 运行所有测试
   ├─ 检查测试覆盖率
   ├─ 验证性能指标（P4）
   ├─ 检查安全性（P3）
   └─ 确认与规范一致

8. 标记完成
   ├─ 更新规范状态为 Implemented
   ├─ 标记任务为完成
   └─ 归档相关文档
```

---

### Ralph Loop 集成

**Ralph Loop 是项目的迭代开发工具，必须与规范驱动开发结合使用。**

**集成方式**：
1. Ralph Loop 的 `PROMPT.md` 必须引用对应的规范文档
2. Ralph Loop 开始时必须先阅读规范
3. Ralph Loop 实施过程中必须遵循 TDD 循环（P2）
4. Ralph Loop 完成后必须验证是否符合规范

**禁止行为**：
- ❌ Ralph Loop 脱离规范独立实施
- ❌ Ralph Loop 跳过 TDD 循环
- ❌ Ralph Loop 修改规范不经过审查

---

### Task-Master 集成

**Task-Master 是项目的任务管理工具，与规范驱动开发互补。**

**功能边界**：
- **Spec-Kit**：定义"怎么做"（How）- 技术规范、API、数据模型、测试
- **Task-Master**：追踪"什么时候做"（When）- 任务进度、优先级、依赖关系

**协作模式**：
```
规范批准 (Spec-Kit)
   ↓
创建任务引用规范 (Task-Master)
   ↓
按规范实施 (Ralph Loop)
   ↓
验证符合规范 (Spec-Kit)
   ↓
标记任务完成 (Task-Master)
```

**关键原则**：
- ✅ 规范先行：先有规范，后有任务
- ✅ 单一职责：各司其职，功能不重合
- ✅ 相互引用：规范引用任务，任务引用规范
- ✅ 保持同步：变更时更新双方

---

## 治理机制

### 宪法修订流程

1. **提案**：任何人可以提出修订建议
2. **讨论**：团队讨论修订必要性
3. **投票**：超过 2/3 核心成员同意
4. **批准**：项目负责人最终批准
5. **发布**：更新版本号，通知所有成员
6. **传播**：更新所有相关模板和文档

### 版本控制

**版本格式**：`MAJOR.MINOR.PATCH`

- **MAJOR**：向后不兼容的原则删除或重定义
- **MINOR**：新增原则或实质性扩展指导
- **PATCH**：澄清、措辞、错别字修复

当前版本：**1.0.0**（初始版本）

---

### 合规审查

**审查触发**：
- 每个 Pull Request 必须检查是否符合本宪章
- 每个规范发布前必须检查是否符合本宪章
- 每个任务完成前必须检查是否符合本宪章

**审查清单**：
- [ ] 规范完整性（P1）
- [ ] TDD 循环遵循（P2）
- [ ] 安全检查通过（P3）
- [ ] 性能指标达标（P4）
- [ ] 向后兼容（P5）
- [ ] 代码与规范一致（P6）

**违规处理**：
- **一级违规**（违反 P2、P3）：立即停止，召集团队分析，制定整改措施
- **二级违规**（违反 P1、P4、P6）：禁止合并，限期整改
- **三级违规**（轻微偏离）：请求修改，补充完善

---

### 运行时指导

**本宪章是项目的最高原则，但日常开发参考**：
- **CLAUDE.md**：项目记忆中枢，包含技术栈、开发约定、工作流程
- **RALPH_LOOP_GUIDE.md**：Ralph Loop 使用指南
- **docs/PRD.md**：产品需求文档
- **docs/development-guide.md**：TDD 自动化开发协议

这些文档必须与本宪章保持一致，如有冲突，以本宪章为准。

---

## 附录：宪法宣誓

**作为项目成员，我宣誓**：

- 我将遵守小芽家教项目宪章的所有原则
- 我将坚持规范先于代码的工作方式
- 我将永不妥协质量标准
- 我将以用户价值为最高指导
- 我将保护儿童数据安全
- 我将保持透明可追溯的工作习惯
- 我将遵循 TDD 开发流程
- 我将保持文档与代码同步

**签名**：_________________
**日期**：_________________

---

**版本**：1.0.0 | **批准日期**：2025-01-12 | **最后修订**：2025-01-12

---

## 最终条款

1. **解释权**：本宪章的最终解释权属于项目负责人
2. **生效日期**：本宪章自发布之日起生效
3. **冲突解决**：当其他文档与本宪章冲突时，以本宪章为准
4. **修订权利**：项目团队保留修订本宪章的权利，但必须遵循修订流程

---

**本宪章是项目的基石，不可动摇。**
