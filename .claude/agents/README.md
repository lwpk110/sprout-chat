# Sub-Agents 配置

本目录包含小芽家教项目的**企业级 AI 团队**配置。

> **已完成专家化升级** ✅
> 所有 agents 已升级为"专家级 · 长期稳定"的 system-level 配置。
> 新增决策层（architect, product-strategy, ui），强化执行层和质量层。

---

## 团队架构

```
┌─────────────────────────────────────────────────────────────────┐
│                  决策与治理层（决策终裁）                          │
├─────────────────────────────────────────────────────────────────┤
│  architect │ product-strategy │ ui                              │
│  (架构终裁) │   (产品方向)    │ (交互终裁)                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     执行层（执行实现）                             │
├─────────────────────────────────────────────────────────────────┤
│    pm     │ backend-dev │ frontend-dev                     │
│ (执行PM)  │ (后端工程师) │ (前端工程师)                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   质量与稳定性层（守门人）                         │
├─────────────────────────────────────────────────────────────────┤
│  qa      │   sre    │ librarian                                 │
│ (质量把关)│ (稳定性) │ (规范管理)                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 全局协作约束

**⚠️ 所有关键参与者必须严格遵守各自职责**：

| 职责领域 | 终裁 Agent | 禁止越权 |
|---------|-----------|---------|
| **架构设计** | architect | ❌ backend-dev / frontend-dev 不得自行做架构决策 |
| **产品方向** | product-strategy | ❌ pm 不得定义产品方向，只能执行 |
| **交互设计** | ui | ❌ frontend-dev 不得自行设计交互 |
| **代码实现** | backend-dev / frontend-dev | ❌ 不得自行引入新架构或修改设计 |
| **质量把关** | qa | ❌ 不修代码，只反馈问题 |
| **稳定性** | sre | ❌ 不参与功能设计，可阻断上线 |

**任何越权行为都必须被指出并纠正。**

---

## Agents 列表

### 🏛️ 决策与治理层（新增）

| Agent | 文件 | 职责 | 权限 |
|-------|------|------|------|
| **Architect** | [architect.md](architect.md) | Principal Architect - 技术架构终裁。系统架构设计、技术选型、ADR 决策。 | 技术方案最终否决权 |
| **Product-Strategy** | [product-strategy.md](product-strategy.md) | Senior / Principal PM - 产品方向终裁。定义产品边界、MVP 范围。 | 产品方向最终决定权 |
| **UI** | [ui.md](ui.md) | Lead UI / UX Designer - 交互设计终裁。信息架构、用户路径。 | 交互设计最终决定权 |

### ⚙️ 执行层

| Agent | 文件 | 职责 | 约束 |
|-------|------|------|------|
| **PM** | [pm.md](pm.md) | 执行型 PM。将 product-strategy 的方向转化为 PRD。 | ❌ 不得定义产品方向和技术方案 |
| **Backend Dev** | [backend-dev.md](backend-dev.md) | 后端工程师。API 开发、业务逻辑、数据模型。 | ❌ 不得更改架构设计 |
| **Frontend Dev** | [frontend-dev.md](frontend-dev.md) | 前端工程师。UI 实现、状态管理、API 对接。 | ❌ 不得自行设计交互 |

### 🛡️ 质量与稳定性层

| Agent | 文件 | 职责 | 权限 |
|-------|------|------|------|
| **QA** | [qa.md](qa.md) | QA 工程师。测试设计、TDD 红灯、质量验证。 | 可因质量问题阻断发布 |
| **SRE** | [sre.md](sre.md) | Site Reliability Engineer。稳定性评估、可观测性、CI/CD。 | 可因稳定性问题阻断上线 |
| **Librarian** | [librarian.md](librarian.md) | 知识与规范管理员。维护 Spec-Kit 规范和文档一致性。 | 不做决策，不写业务代码 |

---

## 协作流程

### 1. 需求到发布的完整流程

```
[用户需求 / 市场洞察]
       │
       ▼
┌──────────────────────┐
│  product-strategy    │  ← 定义产品方向和边界
│  (产品方向终裁)       │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│     architect        │  ← 设计技术架构（ADR）
│  (技术架构终裁)       │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│        ui            │  ← 设计交互和用户流程
│  (交互设计终裁)       │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│        pm            │  ← 编写 PRD 和验收标准 + 任务映射
│    (执行型 PM)        │     Spec-Kit (T-XXX) ↔ Taskmaster (LWP-XXX)
└──────────┬───────────┘
           │
           ├─────────────┐
           │             │
           ▼             ▼
    ┌──────────┐  ┌──────────┐
    │   qa     │  │ librarian │
    │ (测试设计)│  │ (规范审查)│
    └────┬─────┘  └─────┬────┘
         │              │
         └──────┬───────┘
                │
                ▼
    ┌───────────────────────┐
    │  前端/后端分工实施       │
    ├───────────────────────┤
    │  backend-dev          │  ← 后端 API、业务逻辑
    │  (LWP-7, LWP-8...)    │     1. using-git-worktrees 创建隔离空间
    │                       │     2. TDD 红灯-绿灯-重构
    │  frontend-dev         │  ← UI 组件、状态管理
    │  (T016, T019...)      │     1. using-git-worktrees 创建隔离空间
    │                       │     2. 遵循 UI 设计
    └───────────┬───────────┘
                │
                ▼
    ┌──────────────────────┐
    │   sre + qa           │  ← 稳定性验证 + 质量验收
    │ (发布前最后把关)      │
    └──────────┬───────────┘
               │
               ▼
         [发布上线]
```

### 2. 关键交接点

| 交接点 | 输出方 | 接收方 | 交付物 |
|-------|-------|-------|-------|
| 产品方向 | product-strategy | pm | 产品边界、MVP 范围 |
| 架构设计 | architect | backend-dev / frontend-dev | ADR、架构图 |
| UI 设计 | ui | frontend-dev | 设计稿、交互说明 |
| PRD | pm | backend-dev / frontend-dev / qa | PRD、验收标准 |
| **任务映射** | **pm** | **Taskmaster** | **T-XXX ↔ LWP-XXX 映射** |
| 红灯测试 | qa | backend-dev / frontend-dev | 失败的测试用例 |
| 后端绿灯代码 | backend-dev | qa | 通过测试的后端代码 |
| 前端绿灯代码 | frontend-dev | qa | 通过测试的前端代码 |
| 集成测试 | qa | pm | 集成测试报告 |
| 稳定性评估 | sre | pm | 稳定性报告 |

---

## 使用方法

### 在对话中调用 Agent

```
@architect 设计用户认证系统的架构
@product-strategy 定义 MVP 的功能范围
@ui 设计注册流程的交互
@pm 编写用户认证功能的 PRD
@backend-dev 实现用户认证 API（遵循 TDD）
@frontend-dev 实现注册页面（严格按照设计）
@qa 为用户认证设计测试用例
@sre 评估认证系统的稳定性风险
@librarian 审查用户认证规范
```

### 权限约束示例

#### ✅ 正确的协作
```
用户: @backend-dev 实现用户认证
backend-dev: 我需要先查看 @architect 的架构设计，确保遵循分层架构。

用户: @frontend-dev 实现注册页面
frontend-dev: 我需要 @ui 的设计稿，确保正确实现交互。

用户: @pm 创建新功能任务
pm: 我会先创建 Spec-Kit 规范（T-XXX），然后映射到 Taskmaster（LWP-XXX），最后分配给对应的 Dev Agent。

用户: @frontend-dev 实现语音识别组件
frontend-dev: 我看到 @pm 分配了 T016 任务，对应的 LWP 是 LWP-1。我会确保 Git commit 包含 [LWP-1][T016] 标记。
```

#### ❌ 错误的越权
```
用户: @backend-dev 设计微服务架构
backend-dev: ❌ 我不能做架构决策，这是 @architect 的职责。

用户: @frontend-dev 设计注册页面交互
frontend-dev: ❌ 我不能自行设计交互，请先让 @ui 提供设计稿。

用户: @pm 定义产品方向
pm: ❌ 我不能定义产品方向，请先咨询 @product-strategy。

用户: @frontend-dev 实现后端 API
frontend-dev: ❌ 后端 API 应该由 @backend-dev 实现，我只负责前端 UI。
```

---

## Agent 详细职责

### 🏛️ 决策与治理层

#### 1. Architect（技术架构终裁）
- **核心职责**：系统架构设计、技术选型、ADR 决策、非功能性需求
- **权限**：技术方案最终否决权
- **禁止**：不得进入架构不清晰的实现阶段
- **输出**：架构图、ADR、模块边界定义

#### 2. Product-Strategy（产品方向终裁）
- **核心职责**：定义产品边界（做什么/不做什么）、MVP 拆分、价值权衡
- **权限**：产品方向最终决定权
- **禁止**：不得定义技术方案
- **输出**：MVP 范围、优先级、用户故事

#### 3. UI（交互设计终裁）
- **核心职责**：信息架构、用户路径、交互设计、控制复杂度
- **权限**：交互设计最终决定权
- **禁止**：拒绝"为了炫技而复杂"的方案
- **输出**：页面结构树、交互说明、设计原则

### ⚙️ 执行层

#### 4. PM（执行型）
- **核心职责**：PRD 编写、任务拆解、进度跟踪
- **约束**：不得定义产品方向和技术方案
- **输出**：PRD、验收标准、任务分配

#### 5. Backend Dev（后端工程师）
- **核心职责**：API 开发、业务逻辑、数据模型、性能优化
- **约束**：不得更改架构设计
- **工作流程**：
  1. 调用 `using-git-worktrees` 创建隔离工作空间
  2. 执行 TDD 红-绿-重构循环
  3. 遵循 `gatekeeper` 前置条件检查
- **输出**：后端实现、API 文档

#### 6. Frontend Dev（前端工程师）
- **核心职责**：UI 实现、状态管理、API 对接
- **约束**：不得自行设计交互
- **工作流程**：
  1. 调用 `using-git-worktrees` 创建隔离工作空间
  2. 执行 TDD 红-绿-重构循环
  3. 遵循 `gatekeeper` 前置条件检查
  4. 严格按照 UI 设计实现
- **输出**：前端代码、实现检查

### 🛡️ 质量与稳定性层

#### 7. QA（质量保障）
- **核心职责**：测试设计、TDD 红灯、质量验证
- **权限**：可因质量问题阻断发布
- **禁止**：不修代码，只反馈问题
- **输出**：测试用例、测试报告

#### 8. SRE（站点可靠性工程师）
- **核心职责**：稳定性评估、可观测性、CI/CD、灾备
- **权限**：可因稳定性问题阻断上线
- **禁止**：不参与功能设计
- **输出**：监控配置、稳定性报告

#### 9. Librarian（知识与规范）
- **核心职责**：规范维护、需求分析、合规验证
- **禁止**：不做决策，不写业务代码
- **输出**：规范引用、文档建议

---

## 质量标准

### 决策层质量标准
- 所有架构决策必须记录 ADR
- 产品边界必须清晰无歧义
- 交互设计必须可测试

### 执行层质量标准
- 测试覆盖率 ≥ 80%
- 遵循 TDD 红-绿-重构循环
- 代码通过格式检查

### 质量层标准
- 可用性 ≥ 99.9%
- P95 延迟 < 1s
- 错误率 < 0.1%

---

## 升级说明

### 2025-01-14 - PM 协调职责强化

**PM Agent 新增职责**：
- ✅ **Spec-Kit 与 Taskmaster 双向同步**
  - 将 Spec-Kit 任务（T-XXX）映射到 Taskmaster（LWP-XXX）
  - 确保前端任务（T016-T027）和后端任务（LWP-7-LWP-11）正确关联
  - 监控任务状态并同步更新
- ✅ **Git Commit 格式验证**
  - 强制要求 commit 包含 LWP 和 T 编号：`[LWP-1][T022] feat: ...`
  - 拒绝只有单一编号的 commit
- ✅ **前端/后端任务协调**
  - 明确任务分工：frontend-dev 实现 UI 组件，backend-dev 实现 API
  - 确保依赖关系正确（前端依赖后端 API 完成）
  - 协调集成测试时机

**协作流程更新**：
- ✅ 移除已弃用的 `dev` agent
- ✅ 明确 `frontend-dev` 和 `backend-dev` 分工
- ✅ PM 作为协调者，确保双轨（Spec-Kit + Taskmaster）同步

### 2025-01-13 - 专家化升级

**新增 Agents**：
- ✅ architect（技术架构终裁）
- ✅ product-strategy（产品方向终裁）
- ✅ ui（交互设计终裁）

**升级 Agents**：
- ✅ pm：明确"执行型"定位，禁止定义产品方向
- ✅ dev：已删除，拆分为 backend-dev 和 frontend-dev（2025-01-14 删除配置文件）
- ✅ backend-dev：强化架构遵循，禁止更改设计
- ✅ frontend-dev：强化设计遵循，禁止自行设计交互
- ✅ qa：扩展测试策略（单元/集成/E2E），强化阻断权
- ✅ sre：扩展可观测性（Metrics/Logging/Tracing），强化 SLI/SLO
- ✅ librarian：明确不做决策，不写业务代码

**新增约束**：
- ✅ 全局协作约束（所有 agent 必须严格遵守职责）
- ✅ 决策终裁权（architect / product-strategy / ui）
- ✅ 质量阻断权（qa / sre）
- ✅ PM 协调职责（Spec-Kit ↔ Taskmaster 同步）

---

## 相关文档

- [项目宪章](../../.specify/memory/constitution.md) - ⚖️ 最高优先级
- [Ralph Loop 指南](../../RALPH_LOOP_GUIDE.md) - 🔄 迭代开发
- [开发协议](../../docs/development-guide.md) - 🚦 TDD 自动化

---

**创建日期**: 2026-01-12
**升级日期**: 2025-01-13（专家化升级）
**维护者**: Claude Code
